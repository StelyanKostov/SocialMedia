@using Microsoft.AspNetCore.Identity
@using SocialMedia.Data
@model SocialMedia.ViewModels.Profil.ProfilViewModel
@inject SignInManager<ApplicationUser> SignInManager

@{
    var image = Model.Images.Where(x => x.ProfilImage).Select(x => new
    {
        Id = x.Id,
        Extension = x.Extension
    }).FirstOrDefault();

}
<div>

    <div class="container">
        <nav class="navbar navbar-light bg-light">
            <form class="form-inline">
                <a asp-controller="Gallery" asp-action="Index" asp-route-id="@Model.id" class="btn btn-outline-success " type="button">Галерия</a>
                @if (SignInManager.UserManager.GetUserId(this.User) != Model.ApplicationUserId)
                {
                    <a class="btn btn-sm btn-outline-secondary" asp-controller="Messages" asp-action="SendMessages" asp-route-id="@Model.id">Съобщение</a>
                    <a class="btn btn-sm btn-outline-secondary" id="realTimeChat">Чат</a>
                }
            </form>
            
        </nav>
        <div class="row">
            <div class="col">
                <input type="hidden" name="name" value="@Model.id" id="profilId"/>
                @if (Model.Images.Count == 0 || image == null)
                {

                }
                else
                {
                    <img src="~/images/ProfilImage/@Model.UserName/@image.Id.@image.Extension" alt="..." width="500" class="img-fluid">

                }

            </div>

            <div class="col">


                <table class="table table-striped" style="width: 80%">

                    <thead>
                        <tr>

                            <th scope="col"><H2>@Model.UserName</H2></th>

                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">Пол</th>
                            <td>@Model.Gender</td>

                        </tr>
                        <tr>
                            <th scope="row">Харесва</th>
                            <td>@Model.Likes</td>

                        </tr>
                        <tr>
                            <th scope="row">Години</th>
                            <td>@Model.Age</td>

                        </tr>
                        <tr>
                            <th scope="row">От</th>
                            <td>@Model.From</td>

                        </tr>
                        <tr>
                            <th scope="row">Височина</th>
                            <td>@Model.Height</td>

                        </tr>
                        <tr>
                            <th scope="row">Кг</th>
                            <td>@Model.Weight</td>

                        </tr>

                        <tr>
                            <th scope="row">Цвят на очите</th>
                            <td>@Model.EyesColor</td>

                        </tr>
                        <tr>
                            <th scope="row">Цвят на косата</th>
                            <td>@Model.EyesColor</td>

                        </tr>
                        <tr>
                            <th scope="row">Статус</th>
                            <td>@Model.Status</td>

                        </tr>
                        <tr>
                            <th scope="row">Търси</th>
                            <td>@Model.LookingFor</td>

                        </tr>
                    </tbody>

                </table>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <table class="table table-striped">
                    <thead>
                        <tr>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">Цигари</th>
                            <td>@Model.Cigarettes</td>

                        </tr>
                        <tr>
                            <th scope="row">Алкохол</th>
                            <td>@Model.Alcohol</td>

                        </tr>
                        <tr>
                            <th scope="row">Дата на раждане</th>
                            <td>@Model.DateBirthday</td>

                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-5">

                <div class="card">
                    <div class="card-header">
                        Описание
                    </div>
                    <div class="card-body">
                        <p class="card-text">@Model.Description</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var connection =
                new signalR.HubConnectionBuilder()
                    .withUrl("/chatter")
                    .build();

            connection.on("NewMessage",
                function (message) {
                    var chatInfo = `<div>[${message.user}] ${escapeHtml(message.text)}</div>`;
                    $("#messagesList").append(chatInfo);
                });

        document
            .getElementById('realTimeChat')
            .addEventListener('click', function (e) {
                let textareaElement = document.createElement("textarea");
                textareaElement.setAttribute('id', 'messageInput');
                e.currentTarget.parentElement.appendChild(textareaElement);
                let buttonElement = document.createElement("button");
                buttonElement.innerHTML = "Send"
                buttonElement.setAttribute('id', 'sendButton');
                buttonElement.setAttribute('type', 'button')
                e.currentTarget.parentElement.appendChild(buttonElement);

                e.currentTarget.remove();

                $("#sendButton").click(function (event) {

                    console.log(event);
                    var message = $("#messageInput").val();
                    var recipientProfilId = $("#profilId").val();
                    //todoo
                    var chatInfo = `<div>[me] ${escapeHtml(message)}</div>`;
                    $("#messagesList").append(chatInfo);

                    var data = message + '<>=!' + recipientProfilId;
                    connection.invoke("SendToOneProfil", data);
                    $("#messageInput").val("");

                    
                    
                });

                connection.start().catch(function (err) {
                    return console.error(err.toString());
                });

                function escapeHtml(unsafe) {
                    return unsafe
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                }

        })



           </script>
}